

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>materials_commons.cli.subcommands.fetch &mdash; materials_commons.cli 2.1.3 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../site-static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../../site-static/css/theme.css?v=e59714d7" />

  
      <script src="../../../../site-static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../site-static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../site-static/documentation_options.js?v=179ab080"></script>
      <script src="../../../../site-static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../site-static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../site-static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            materials_commons.cli
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../manual/index.html">User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/mc/index.html">``mc`` Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/materials_commons/modules.html">``materials_commons.cli`` Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../help.html">Getting help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">materials_commons.cli</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">materials_commons.cli.subcommands.fetch</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for materials_commons.cli.subcommands.fetch</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">materials_commons.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mcapi</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">materials_commons.cli.functions</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">clifuncs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">materials_commons.cli.tree_functions</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">treefuncs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">materials_commons.cli.file_functions</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">filefuncs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">materials_commons.cli.treedb</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalTree</span><span class="p">,</span> <span class="n">RemoteTree</span>


<div class="viewcode-block" id="print_fetch_status">
<a class="viewcode-back" href="../../../../reference/materials_commons/materials_commons.cli.subcommands.fetch.html#materials_commons.cli.subcommands.fetch.print_fetch_status">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">print_fetch_status</span><span class="p">(</span><span class="n">pconfig</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pconfig</span><span class="o">.</span><span class="n">remote_updatetime</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fetch lock set at:&quot;</span><span class="p">,</span> <span class="n">clifuncs</span><span class="o">.</span><span class="n">format_time</span><span class="p">(</span><span class="n">pconfig</span><span class="o">.</span><span class="n">remote_updatetime</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Project data will at least reflect remote changes that happened before this time.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;**Changes that happen after this time may not be reflected in CLI output**.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Do `mc fetch --unlock` to turn off the fetch lock.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fetch lock off&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Project data will always be fetched from remote.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="make_parser">
<a class="viewcode-back" href="../../../../reference/materials_commons/materials_commons.cli.subcommands.fetch.html#materials_commons.cli.subcommands.fetch.make_parser">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_parser</span><span class="p">():</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;By default, remote data is fetched for every request. To be more efficient, some remote data can be fetched and cached using `mc fetch --lock`. When &#39;locked&#39;, remote data is recovered from a local cache if it has been updated since the lock was put in place. Any data fetched before the lock was put in place is still updated as necessary. To the extent possible, the cache will be updated when the remote is modified via the `mc` command line. While the lock is in place, use `mc fetch &lt;path&gt;` to force the update of data for particular files or directories. To reset the lock time, use `mc fetch --lock` again. To stop caching, use `mc fetch --unlock`.&quot;</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
        <span class="n">prog</span><span class="o">=</span><span class="s1">&#39;mc fetch&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;paths&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Files or directories&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s1">&#39;--recursive&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Fetch data recursively for specified paths.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Print verbosely.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-children&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Do not update data for children of directories.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--lock&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Only fetch data to replace records older than now.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--unlock&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Always fetch data.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--status&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Display fetch lock status.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span></div>


<div class="viewcode-block" id="fetch_subcommand">
<a class="viewcode-back" href="../../../../reference/materials_commons/materials_commons.cli.subcommands.fetch.html#materials_commons.cli.subcommands.fetch.fetch_subcommand">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_subcommand</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="n">working_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch remote data</span>

<span class="sd">    mc fetch [--recursive] [&lt;path&gt;...]</span>
<span class="sd">    mc fetch --lock</span>
<span class="sd">    mc fetch --unlock</span>
<span class="sd">    mc fetch --status</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">make_parser</span><span class="p">()</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>

    <span class="n">proj</span> <span class="o">=</span> <span class="n">clifuncs</span><span class="o">.</span><span class="n">make_local_project</span><span class="p">(</span><span class="n">working_dir</span><span class="p">)</span>
    <span class="n">pconfig</span> <span class="o">=</span> <span class="n">clifuncs</span><span class="o">.</span><span class="n">read_project_config</span><span class="p">(</span><span class="n">proj</span><span class="o">.</span><span class="n">local_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
        <span class="n">pconfig</span><span class="o">.</span><span class="n">remote_updatetime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">pconfig</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">print_fetch_status</span><span class="p">(</span><span class="n">pconfig</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">unlock</span><span class="p">:</span>
        <span class="n">pconfig</span><span class="o">.</span><span class="n">remote_updatetime</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pconfig</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">print_fetch_status</span><span class="p">(</span><span class="n">pconfig</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
        <span class="n">print_fetch_status</span><span class="p">(</span><span class="n">pconfig</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">paths</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Nothing to fetch&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">remotetree</span> <span class="o">=</span> <span class="n">RemoteTree</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">refpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">proj</span><span class="o">.</span><span class="n">local_path</span><span class="p">)</span>

        <span class="n">get_children</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">no_children</span><span class="p">:</span>
            <span class="n">get_children</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">mcpaths</span> <span class="o">=</span> <span class="n">treefuncs</span><span class="o">.</span><span class="n">clipaths_to_mcpaths</span><span class="p">(</span><span class="n">proj</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">paths</span><span class="p">,</span>
                                                <span class="n">working_dir</span><span class="p">)</span>

        <span class="n">remotetree</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">mcpath</span> <span class="ow">in</span> <span class="n">mcpaths</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;fetch:&quot;</span><span class="p">,</span> <span class="n">mcpath</span><span class="p">)</span>
            <span class="n">remotetree</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">mcpath</span><span class="p">,</span>
                <span class="n">get_children</span><span class="o">=</span><span class="n">get_children</span><span class="p">,</span>
                <span class="n">recurs</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">recursive</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">remotetree</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, PRISMS Center.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>